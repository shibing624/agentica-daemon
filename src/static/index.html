<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agentica</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%234A90D9'/%3E%3Cstop offset='100%25' stop-color='%23A8D8EA'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23g)'/%3E%3Cellipse cx='50' cy='52' rx='28' ry='30' fill='%23E8F4FD'/%3E%3Ccircle cx='40' cy='42' r='4' fill='%232C3E50'/%3E%3Ccircle cx='60' cy='42' r='4' fill='%232C3E50'/%3E%3Ccircle cx='41' cy='41' r='1.2' fill='white'/%3E%3Ccircle cx='61' cy='41' r='1.2' fill='white'/%3E%3Cellipse cx='50' cy='54' rx='6' ry='3' fill='%234A90D9' opacity='0.3'/%3E%3Cpath d='M44 50 Q50 56 56 50' stroke='%232C3E50' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Cpath d='M26 28 Q22 12 35 18' stroke='%234A90D9' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Cpath d='M74 28 Q78 12 65 18' stroke='%234A90D9' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#fff;--bg2:#f7f7f8;--bg3:#efefef;--bg-input:#f7f7f8;
  --fg:#1a1a1a;--fg2:#6b6b6b;--fg3:#999;
  --border:#e5e5e5;--border2:#f0f0f0;
  --accent:#1a1a1a;--accent-soft:rgba(0,0,0,.05);
  --sidebar-w:260px;--radius:12px;--radius-sm:8px;
  --mono:'SF Mono',Menlo,Consolas,'Liberation Mono',monospace;
  --sans:-apple-system,BlinkMacSystemFont,'Segoe UI','Helvetica Neue',sans-serif;
  --t:150ms ease;
  --user-bg:#1a1a1a;--user-fg:#fff;
  --code-bg:#f4f4f4;
}
[data-theme="dark"]{
  --bg:#0a0a0a;--bg2:#141414;--bg3:#222;--bg-input:#141414;
  --fg:#e0e0e0;--fg2:#888;--fg3:#555;
  --border:#222;--border2:#1a1a1a;
  --accent:#e0e0e0;--accent-soft:rgba(255,255,255,.05);
  --user-bg:#222;--user-fg:#e0e0e0;
  --code-bg:#1a1a1a;
}
html,body{height:100%;overflow:hidden}
body{font-family:var(--sans);font-size:14px;line-height:1.6;color:var(--fg);background:var(--bg);display:flex;transition:background .2s,color .2s}
::selection{background:rgba(100,100,100,.2)}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-track{background:transparent}

/* ===== SIDEBAR ===== */
.sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);height:100vh;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:margin var(--t),background .2s}
.sidebar.collapsed{margin-left:calc(-1 * var(--sidebar-w))}
.side-head{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.brand{display:flex;align-items:center;gap:8px;font-weight:600;font-size:14px}
.brand-dot{width:8px;height:8px;border-radius:50%;background:var(--fg)}
.new-btn{padding:5px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--fg);font-size:12px;cursor:pointer;transition:all var(--t);font-weight:500}
.new-btn:hover{background:var(--bg3)}
.side-search{padding:8px 12px}
.side-search input{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg);color:var(--fg);font-size:13px;outline:none;transition:border var(--t)}
.side-search input:focus{border-color:var(--fg3)}
.side-search input::placeholder{color:var(--fg3)}
.s-list{flex:1;overflow-y:auto;padding:4px 8px}
.s-item{padding:10px 12px;border-radius:var(--radius-sm);cursor:pointer;transition:all var(--t);margin-bottom:1px;position:relative}
.s-item:hover{background:var(--bg3)}
.s-item.active{background:var(--accent-soft);font-weight:500}
.s-item .ti{font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:24px}
.s-item .mt{font-size:11px;color:var(--fg3);margin-top:2px}
.s-item .db{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:22px;height:22px;border:none;background:transparent;color:var(--fg3);border-radius:4px;cursor:pointer;display:none;align-items:center;justify-content:center;font-size:12px;transition:all var(--t)}
.s-item:hover .db{display:flex}
.s-item .db:hover{background:var(--fg);color:var(--bg)}
.s-empty{padding:20px;text-align:center;color:var(--fg3);font-size:13px}

/* ===== MAIN ===== */
.main{flex:1;display:flex;flex-direction:column;height:100vh;min-width:0;transition:background .2s}
.topbar{padding:6px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);min-height:40px;gap:8px}
.tb-l{display:flex;align-items:center;gap:8px;min-width:0;flex-shrink:0}
.ib{width:28px;height:28px;border:none;background:transparent;color:var(--fg2);border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all var(--t);flex-shrink:0}
.ib:hover{background:var(--bg3);color:var(--fg)}

/* logo + brand in topbar left */
.top-brand{display:flex;align-items:center;gap:6px;font-weight:600;font-size:13px;color:var(--fg);user-select:none}
.top-brand img{width:20px;height:20px;border-radius:4px}
.top-brand .ver{font-size:10px;color:var(--fg3);font-weight:400;font-family:var(--mono)}

/* model selector */
.model-sel{display:flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--fg);font-size:12px;font-weight:500;cursor:pointer;transition:all var(--t);position:relative;font-family:var(--sans)}
.model-sel:hover{background:var(--bg3)}
.model-sel .arr{font-size:9px;color:var(--fg3);margin-left:2px}
/* model dropdown */
.model-dd{position:absolute;top:calc(100% + 4px);left:0;min-width:280px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:0 4px 16px rgba(0,0,0,.1);z-index:200;display:none;max-height:400px;overflow-y:auto}
.model-dd.open{display:block}
.dd-group{padding:8px 0}
.dd-group-title{padding:4px 14px;font-size:11px;color:var(--fg3);text-transform:uppercase;letter-spacing:.05em;font-weight:600}
.dd-item{padding:7px 14px;font-size:13px;cursor:pointer;transition:all var(--t);display:flex;align-items:center;justify-content:space-between}
.dd-item:hover{background:var(--bg3)}
.dd-item.current{color:var(--fg);font-weight:500}
.dd-item.current::after{content:'‚úì';font-size:12px;color:var(--fg2)}

.tb-r{display:flex;align-items:center;gap:8px;flex-shrink:0;min-width:0;overflow:hidden}
.tb-info{font-size:10px;color:var(--fg3);font-family:var(--mono);display:flex;align-items:center;gap:10px;white-space:nowrap;line-height:1.3;text-decoration:none}
.tb-info b{text-decoration:none}
.tb-info .sep{color:var(--border);font-size:8px}
/* tokens tooltip */
.tok-wrap{position:relative;cursor:default;text-decoration:none!important;border:none!important;box-shadow:none!important}
.tok-wrap,.tok-wrap *{text-decoration:none!important;border-bottom:none!important}
.tok-wrap .tok-tip{display:none;position:absolute;top:calc(100% + 6px);right:0;background:var(--fg);color:var(--bg);font-size:11px;padding:6px 10px;border-radius:6px;white-space:nowrap;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.15)!important;pointer-events:none}
.tok-wrap:hover .tok-tip{display:block}
/* editable dir */
.dir-wrap{position:relative;cursor:pointer}
.dir-wrap:hover{color:var(--fg2)}

/* dir modal overlay */
.dir-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:none;align-items:center;justify-content:center}
.dir-modal-overlay.open{display:flex}
.dir-modal{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.18);width:520px;max-width:90vw;padding:20px;animation:modalIn .15s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:none}}
.dir-modal h3{font-size:14px;font-weight:600;margin-bottom:12px;color:var(--fg)}
.dir-modal .dm-row{display:flex;gap:8px;align-items:center;margin-bottom:12px;width:100%}
.dir-modal input{flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-input);color:var(--fg);font-size:12px;font-family:var(--mono);outline:none}
.dir-modal input:focus{border-color:var(--fg3);box-shadow:0 0 0 2px var(--accent-soft)}
.dir-modal .dm-actions{display:flex;gap:6px;justify-content:space-between;align-items:center}
.dir-modal .dm-left{display:flex;gap:6px}
.dir-modal .dm-right{display:flex;gap:6px}
.dp-btn{padding:6px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--fg);font-size:12px;cursor:pointer;white-space:nowrap;font-weight:500;display:flex;align-items:center;gap:5px;transition:all var(--t)}
.dp-btn:hover{background:var(--bg3)}
.dp-btn.primary{background:var(--fg);color:var(--bg);border-color:var(--fg)}
.dp-btn.danger{background:#d33;color:#fff;border-color:#d33}
.dp-btn.danger:hover{background:#b22;border-color:#b22}
/* toast */
.toast{position:fixed;top:24px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--fg);color:var(--bg);font-size:13px;padding:10px 20px;border-radius:8px;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2);transition:transform .3s ease,opacity .3s ease;opacity:0;pointer-events:none;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
/* dir dropdown in modal */
.dir-input-wrap{position:relative;display:flex;align-items:center;gap:0;width:100%}
.dir-input-wrap input{flex:1;border-radius:var(--radius-sm) 0 0 var(--radius-sm)!important}
.dir-toggle-btn{padding:8px 10px;border:1px solid var(--border);border-left:none;border-radius:0 var(--radius-sm) var(--radius-sm) 0;background:var(--bg-input);color:var(--fg2);cursor:pointer;display:flex;align-items:center;transition:all var(--t)}
.dir-toggle-btn:hover{background:var(--bg3);color:var(--fg)}
.dir-toggle-btn svg{width:14px;height:14px;transition:transform .2s}
.dir-toggle-btn.open svg{transform:rotate(180deg)}
.dir-history-dropdown{position:absolute;top:100%;left:0;right:0;max-height:240px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:10;display:none}
.dir-history-dropdown.open{display:block}
.dir-history-item{padding:8px 12px;cursor:pointer;transition:background var(--t)}
.dir-history-item:hover{background:var(--bg3)}
.dir-history-item .dh-short{font-size:13px;font-weight:500;color:var(--fg)}
.dir-history-item .dh-full{font-size:11px;color:var(--fg3);font-family:var(--mono);margin-top:2px}
.dir-history-empty{padding:12px;text-align:center;font-size:12px;color:var(--fg3)}
/* confirm modal */
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:600;display:none;align-items:center;justify-content:center}
.confirm-overlay.open{display:flex}
.confirm-box{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.18);width:340px;max-width:90vw;padding:20px;animation:modalIn .15s ease;text-align:center}
.confirm-box .cm-msg{font-size:13px;color:var(--fg);margin-bottom:16px;line-height:1.5}
.confirm-box .cm-actions{display:flex;gap:8px;justify-content:center}
.dp-btn.primary:hover{opacity:.8}
.dp-btn svg{width:13px;height:13px;fill:currentColor}

/* scroll to bottom button ‚Äî positioned in chat-wrap, stays fixed visually */
.chat-wrap{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column}
.scroll-bottom-btn{position:absolute;bottom:12px;right:24px;width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--bg);color:var(--fg2);cursor:pointer;display:none;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.12);z-index:50;transition:all var(--t)}
.scroll-bottom-btn:hover{background:var(--bg3);color:var(--fg);box-shadow:0 2px 12px rgba(0,0,0,.18)}
.scroll-bottom-btn.visible{display:flex}
.scroll-bottom-btn svg{width:16px;height:16px}

/* ===== CHAT ===== */
.chat{flex:1;overflow-y:auto;padding:0 20px}
.msgs{margin:0 auto;padding:16px 24px}
.m{margin-bottom:12px;animation:fu .2s ease}
@keyframes fu{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.m-u{display:flex;justify-content:flex-start}
.m-u .bub{background:var(--user-bg);color:var(--user-fg);padding:8px 14px;border-radius:var(--radius-sm);max-width:85%;font-size:13px;line-height:1.55;word-break:break-word;white-space:pre-wrap}
.m-a{display:flex;flex-direction:column;gap:0}

/* collapsible section (shared by thinking & tool blocks) */
.sec-block{margin:2px 0 4px 0;border-radius:var(--radius-sm);overflow:hidden;transition:all .2s}
.sec-toggle{display:flex;align-items:center;gap:6px;padding:5px 10px;cursor:pointer;user-select:none;font-size:12px;transition:all var(--t);border-radius:var(--radius-sm)}
.sec-toggle:hover{filter:brightness(.92)}
.sec-toggle .arrow{font-size:9px;transition:transform .2s;display:inline-block;opacity:.6}
.sec-toggle .arrow.open{transform:rotate(90deg)}
.sec-toggle .sec-icon{font-size:13px}
.sec-toggle .sec-lbl{font-weight:600;font-size:11px;letter-spacing:.02em}
.sec-toggle .sec-detail{font-weight:400;font-size:10px;opacity:.6;margin-left:2px}
.sec-body{display:none;padding:0;max-height:500px;overflow-y:auto;margin:0 2px 2px;border-radius:0 0 6px 6px}
.sec-body.open{display:block}

/* thinking section ‚Äî dim italic style */
.sec-block.sec-thinking .sec-toggle{background:var(--bg2);color:var(--fg3)}
.sec-block.sec-thinking .sec-lbl{color:var(--fg3);font-style:italic;font-weight:500}
.sec-thinking .think-content{padding:6px 12px;font-size:12px;line-height:1.5;color:var(--fg3);font-style:italic;white-space:pre-wrap;word-break:break-word;background:var(--bg2);border-top:1px solid var(--border2)}

/* tool calls section ‚Äî cyan accent */
.sec-block.sec-tools .sec-toggle{background:rgba(74,144,217,.08);color:#4a90d9}
[data-theme="dark"] .sec-block.sec-tools .sec-toggle{background:rgba(74,144,217,.12);color:#6bb0f0}
.sec-block.sec-tools .sec-lbl{color:inherit}
/* todo section ‚Äî amber/warm accent */
.sec-block.sec-todos .sec-toggle{background:rgba(217,159,50,.10);color:#b07d20}
[data-theme="dark"] .sec-block.sec-todos .sec-toggle{background:rgba(217,159,50,.14);color:#e0a830}
.sec-block.sec-todos .sec-lbl{color:inherit}
.sec-block.sec-todos .todo-list{padding:4px 10px;background:rgba(217,159,50,.04);border-top:1px solid var(--border2)}
[data-theme="dark"] .sec-block.sec-todos .todo-list{background:rgba(217,159,50,.06)}
.sec-block.sec-todos .todo-row{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:12px;line-height:1.4}
.sec-block.sec-todos .todo-st{flex-shrink:0;font-size:13px}
.sec-block.sec-todos .todo-txt{color:var(--fg);word-break:break-word}
/* task section ‚Äî purple accent */
.sec-block.sec-task .sec-toggle{background:rgba(160,80,200,.08);color:#9050c0}
[data-theme="dark"] .sec-block.sec-task .sec-toggle{background:rgba(160,80,200,.12);color:#c080e8}
.sec-block.sec-task .sec-lbl{color:inherit}
/* task subagent inner tool list */
.task-inner{padding:4px 10px;background:rgba(160,80,200,.03);border-top:1px solid var(--border2)}
[data-theme="dark"] .task-inner{background:rgba(160,80,200,.05)}
.task-inner-row{display:flex;align-items:center;gap:5px;padding:2px 0;font-size:11px;line-height:1.3;font-family:var(--mono)}
.task-inner-row .ti-icon{flex-shrink:0;font-size:12px}
.task-inner-row .ti-name{font-weight:600;color:#9050c0;white-space:nowrap}
[data-theme="dark"] .task-inner-row .ti-name{color:#c080e8}
.task-inner-row .ti-info{color:var(--fg3);word-break:break-word}
.task-inner-more{font-size:10px;color:var(--fg3);font-style:italic;padding:2px 0}
.task-summary{font-size:10px;color:var(--fg3);font-style:italic;padding:3px 0 1px;border-top:1px solid var(--border2);margin-top:2px}
.tool-item{padding:5px 12px;font-size:12px;display:flex;align-items:flex-start;gap:6px;border-bottom:1px solid var(--border2);background:var(--bg2)}
.tool-item:last-child{border-bottom:none}
.tool-item .t-icon{flex-shrink:0;font-size:13px;line-height:1.4}
.tool-item .t-name{font-weight:600;color:#b060c0;font-family:var(--mono);font-size:12px;white-space:nowrap}
[data-theme="dark"] .tool-item .t-name{color:#d49ce3}
.tool-item .t-args{color:var(--fg3);font-size:11px;font-family:var(--mono);word-break:break-all;line-height:1.4}
/* single tool inline in toggle */
.sec-lbl.tool-inline{color:#b060c0;font-family:var(--mono)}
[data-theme="dark"] .sec-lbl.tool-inline{color:#d49ce3}
.sec-detail.tool-inline-args{opacity:1;font-size:11px;color:var(--fg2)}
/* diff stats for file tools */
.diff-add{color:#1a7f37;font-weight:600;font-family:var(--mono);font-size:11px}
.diff-del{color:#cf222e;font-weight:600;font-family:var(--mono);font-size:11px}
[data-theme="dark"] .diff-add{color:#3fb950}
[data-theme="dark"] .diff-del{color:#f85149}
.file-path{color:var(--fg2);font-family:var(--mono);font-size:11px}
.line-range{color:var(--fg3);font-family:var(--mono);font-size:10px}
.tool-result{padding:3px 12px 5px 30px;font-size:10px;color:var(--fg3);font-family:var(--mono);white-space:pre-wrap;word-break:break-all;max-height:80px;overflow-y:auto;background:var(--bg2);border-bottom:1px solid var(--border2);opacity:.7}
.tool-result:last-child{border-bottom:none}

.m-a .bub{padding:2px 0;max-width:100%;font-size:13px;line-height:1.6;color:var(--fg);word-break:break-word}
/* streaming indicator ‚Äî ChatGPT-style pulsing dot */
.streaming .bub::after{content:'';display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--fg2);margin-left:3px;vertical-align:middle;animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.2;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}

/* markdown ‚Äî compact Claude Code style */
.bub p{margin:0 0 4px}.bub p:last-child{margin:0}
.bub strong{font-weight:600}
.bub em{font-style:italic}
.bub code{font-family:var(--mono);font-size:12px;background:var(--code-bg);padding:1px 4px;border-radius:3px}
.bub pre{background:var(--code-bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;margin:4px 0;overflow-x:auto;font-size:12px;line-height:1.45;transition:all .2s;position:relative}
.bub pre code{background:transparent;padding:0}
.bub ul,.bub ol{padding-left:18px;margin:2px 0}
.bub li{margin:0;font-size:13px;line-height:1.4;padding:0}
.bub li+li{margin-top:0}
.bub li p{margin:0;display:inline}
.bub ul br,.bub ol br{display:none}
.bub blockquote{border-left:2px solid var(--border);padding-left:10px;color:var(--fg2);margin:4px 0;font-size:13px}
.bub a{color:var(--fg);text-decoration:underline;text-underline-offset:2px}
.bub a:hover{opacity:.7}
.bub table{border-collapse:collapse;margin:4px 0;width:100%;font-size:12px}
.bub th,.bub td{border:1px solid var(--border);padding:4px 8px;text-align:left}
.bub th{background:var(--bg2);font-weight:500}
.bub h1,.bub h2,.bub h3,.bub h4,.bub h5,.bub h6{font-weight:600;margin:8px 0 3px;line-height:1.35}
.bub h1{font-size:16px}.bub h2{font-size:14px}.bub h3{font-size:13px}.bub h4{font-size:13px;font-weight:500}.bub h5{font-size:12px;font-weight:500}.bub h6{font-size:12px;font-weight:400;color:var(--fg2)}
.bub .katex-display{margin:6px 0;overflow-x:auto}
.bub .katex{font-size:14px}
.bub hr{border:none;border-top:1px solid var(--border);margin:6px 0}

/* ===== INPUT ===== */
.input-area{padding:8px 20px 4px;background:var(--bg);transition:background .2s}
.input-box{margin:0 auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-input);transition:all var(--t);position:relative}
.input-box:focus-within{border-color:var(--fg3);box-shadow:0 0 0 2px var(--accent-soft)}
.input-box.dragover{border-color:var(--fg);background:var(--accent-soft)}
/* file preview */
.file-list{display:flex;flex-wrap:wrap;gap:6px;padding:8px 12px 0;min-height:0}
.file-chip{display:flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--fg2);font-family:var(--mono)}
.file-chip .fx{cursor:pointer;color:var(--fg3);font-size:14px;margin-left:2px}
.file-chip .fx:hover{color:var(--fg)}
.input-ta{width:100%;min-height:44px;max-height:200px;padding:12px 48px 12px 14px;border:none;background:transparent;color:var(--fg);font-size:14px;line-height:1.6;resize:none;outline:none;font-family:var(--sans)}
.input-ta::placeholder{color:var(--fg3)}
/* bottom bar */
.input-foot{display:flex;align-items:center;justify-content:space-between;padding:4px 8px 8px}
.input-foot-l{display:flex;align-items:center;gap:6px}
.attach-btn{width:28px;height:28px;border:none;background:transparent;color:var(--fg3);border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all var(--t)}
.attach-btn:hover{background:var(--bg3);color:var(--fg)}
.input-foot-r{display:flex;align-items:center;gap:4px}
/* action button */
.act-btn{width:32px;height:32px;border:none;border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--t)}
.act-btn.send{background:var(--fg);color:var(--bg)}
.act-btn.send:hover{opacity:.8}
.act-btn.send:disabled{opacity:.15;cursor:not-allowed}
.act-btn.stop{background:var(--fg);color:var(--bg)}
.act-btn.stop:hover{opacity:.8}
.act-btn svg{width:16px;height:16px;fill:currentColor}
/* disclaimer at bottom */
.bottom-info{margin:0 auto;padding:2px 0 6px;text-align:center;font-size:11px;color:var(--fg3)}

/* ===== WELCOME ===== */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;color:var(--fg2);gap:12px}
.w-icon{width:48px;height:48px;border-radius:50%;background:var(--fg);display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--bg);font-weight:700}
.welcome h2{font-size:20px;font-weight:600;color:var(--fg);letter-spacing:-.02em}
.welcome p{font-size:13px;max-width:380px;color:var(--fg2)}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  .sidebar{position:fixed;z-index:100;height:100vh;box-shadow:2px 0 8px rgba(0,0,0,.1)}
  .sidebar.collapsed{margin-left:calc(-1 * var(--sidebar-w))}
  .model-dd{min-width:240px}
  .tb-info{font-size:9px;gap:6px}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="side-head">
    <div class="brand"><span class="brand-dot"></span> Agentica</div>
    <button class="new-btn" onclick="newSession()">+ New</button>
  </div>
  <div class="side-search">
    <input type="text" id="searchInput" placeholder="Search..." oninput="filterSessions()">
  </div>
  <div class="s-list" id="sessionList"><div class="s-empty">No sessions</div></div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="tb-l">
      <button class="ib" onclick="toggleSidebar()" title="Toggle sidebar">&#x2630;</button>
      <!-- Logo + Brand + Version -->
      <div class="top-brand">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%234A90D9'/%3E%3Cstop offset='100%25' stop-color='%23A8D8EA'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23g)'/%3E%3Cellipse cx='50' cy='52' rx='28' ry='30' fill='%23E8F4FD'/%3E%3Ccircle cx='40' cy='42' r='4' fill='%232C3E50'/%3E%3Ccircle cx='60' cy='42' r='4' fill='%232C3E50'/%3E%3Ccircle cx='41' cy='41' r='1.2' fill='white'/%3E%3Ccircle cx='61' cy='41' r='1.2' fill='white'/%3E%3Cellipse cx='50' cy='54' rx='6' ry='3' fill='%234A90D9' opacity='0.3'/%3E%3Cpath d='M44 50 Q50 56 56 50' stroke='%232C3E50' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Cpath d='M26 28 Q22 12 35 18' stroke='%234A90D9' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3Cpath d='M74 28 Q78 12 65 18' stroke='%234A90D9' stroke-width='5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E" alt="logo">
        <span>Agentica</span>
        <span class="ver" id="verLabel">v0.1.1</span>
      </div>
      <!-- Model selector -->
      <div style="position:relative" id="modelWrap">
        <button class="model-sel" id="modelBtn" onclick="toggleModelDD()">
          <span id="modelLabel">-</span>
          <span class="arr">&#x25BC;</span>
        </button>
        <div class="model-dd" id="modelDD"></div>
      </div>
    </div>
    <div class="tb-r">
      <div class="tb-info">
        <span class="tok-wrap">
          Tokens: <b id="tokIn">0</b> in / <b id="tokOut">0</b> out
          <span class="tok-tip" id="tokTip">Session tokens ‚Äî Input: prompt + context, Output: generated response</span>
        </span>
        <span class="sep">|</span>
        <span class="dir-wrap" id="dirWrap" onclick="openDirModal()">
          Dir: <b id="dirVal">-</b>
        </span>
      </div>
      <button class="ib" onclick="toggleTheme()" id="themeBtn" title="Toggle theme">&#x263E;</button>
    </div>
  </div>

  <div class="chat-wrap">
    <div class="chat" id="chatArea">
      <div class="msgs" id="messages"></div>
    </div>
    <button class="scroll-bottom-btn" id="scrollBottomBtn" onclick="scrollEnd()" title="Scroll to bottom">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v10m0 0l-4-4m4 4l4-4"/></svg>
    </button>
  </div>

  <div class="input-area">
    <div class="input-box" id="inputBox">
      <div class="file-list" id="fileList"></div>
      <textarea class="input-ta" id="inputTa" placeholder="Send a message..." rows="1"
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <div class="input-foot">
        <div class="input-foot-l">
          <button class="attach-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">&#x1F4CE;</button>
          <input type="file" id="fileInput" multiple style="display:none" onchange="onFilePick(event)">
        </div>
        <div class="input-foot-r">
          <button class="act-btn send" id="actBtn" onclick="onAction()" title="Send (Enter)"><svg viewBox="0 0 16 16" width="16" height="16"><path d="M12 3v5a2 2 0 01-2 2H4m0 0l3-3M4 10l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
        </div>
      </div>
    </div>
    <div class="bottom-info">AI ÂèØËÉΩ‰ºöÁäØÈîôÔºåËØ∑Ê†∏ÂÆûÈáçË¶Å‰ø°ÊÅØ„ÄÇ</div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Dir Modal -->
<div class="dir-modal-overlay" id="dirModalOverlay" onclick="closeDirModal(event)">
  <div class="dir-modal" onclick="event.stopPropagation()">
    <h3>Working Directory</h3>
    <div class="dm-row">
      <div class="dir-input-wrap">
        <input type="text" id="dirEditInput" placeholder="/path/to/project"
               onkeydown="if(event.key==='Enter')saveDir()"
               oninput="filterDirHistory()">
        <button class="dir-toggle-btn" id="dirToggleBtn" onclick="toggleDirHistory()" title="ÂéÜÂè≤Ë∑ØÂæÑ">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6l4 4 4-4"/></svg>
        </button>
        <div class="dir-history-dropdown" id="dirHistoryDD"></div>
      </div>
    </div>
    <div class="dm-actions">
      <div class="dm-left">
        <button class="dp-btn" onclick="copyDir()" title="Copy path">
          <svg viewBox="0 0 16 16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg>
          Copy
        </button>
        <button class="dp-btn" onclick="openInFinder()" title="Open in Finder">
          <svg viewBox="0 0 16 16"><path d="M1.75 1A1.75 1.75 0 000 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0016 13.25v-8.5A1.75 1.75 0 0014.25 3H7.5a.25.25 0 01-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75z"/></svg>
          Finder
        </button>
        <button class="dp-btn" onclick="openInTerminal()" title="Open in Terminal">
          <svg viewBox="0 0 16 16"><path d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0114.25 15H1.75A1.75 1.75 0 010 13.25V2.75zm7 7.5a.75.75 0 000 1.5h4.25a.75.75 0 000-1.5H7zm-3.22-4.97a.75.75 0 00-1.06 1.06L4.44 8 2.72 9.72a.75.75 0 101.06 1.06l2-2a.75.75 0 000-1.06l-2-2z"/></svg>
          Terminal
        </button>
      </div>
      <div class="dm-right">
        <button class="dp-btn" onclick="closeDirModal()">Cancel</button>
        <button class="dp-btn primary" onclick="saveDir()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="confirm-overlay" id="confirmOverlay" onclick="confirmCancel(event)">
  <div class="confirm-box" onclick="event.stopPropagation()">
    <div class="cm-msg" id="confirmMsg">Á°ÆÂÆöÂà†Èô§Ôºü</div>
    <div class="cm-actions">
      <button class="dp-btn" onclick="confirmCancel()">ÂèñÊ∂à</button>
      <button class="dp-btn danger" id="confirmOkBtn" onclick="confirmOk()">Âà†Èô§</button>
    </div>
  </div>
</div>

<script>
// ============ STATE ============
const API = '';
let curSess = null;
let sessions = {};
let streaming = false;
let abortCtrl = null;
let pendingFiles = [];
let serverModel = '-';
let serverDir = '';
let serverProvider = '';
let serverModelName = '';
let serverVersion = '';
let modelsData = null;
let userScrolledUp = false;

const TOOL_ICONS = {
  ls:'üìÅ', read_file:'üìñ', write_file:'‚úèÔ∏è', edit_file:'‚úÇÔ∏è',
  glob:'üîç', grep:'üîé', execute:'‚ö°', web_search:'üåê',
  fetch_url:'üîó', write_todos:'üìã', read_todos:'üìã',
  task:'ü§ñ', save_memory:'üíæ', default:'üîß',
};
function toolIcon(name){return TOOL_ICONS[name]||TOOL_ICONS.default}
// Display name mapping for tools
const TOOL_DISPLAY={'write_todos':'todos','read_todos':'todos'};
function toolDisplay(name){return TOOL_DISPLAY[name]||name}
// Determine section CSS class based on tool type
function toolSecClass(name){
  if(name==='write_todos'||name==='read_todos') return 'sec-todos';
  if(name==='task') return 'sec-task';
  return 'sec-tools';
}

// Smart format tool args for display
function fmtToolArgs(name, args){
  if(!args||typeof args!=='object') return args?String(args):'';
  try{
    switch(name){
      case 'read_file':{
        const f=args.file_path||args.file||args.path||args.filename||'';
        const short=shortenFilePath(f);
        const parts=[short];
        if(args.offset!=null||args.limit!=null){
          const s=(args.offset||0)+1, e=args.limit?(args.offset||0)+args.limit:'';
          parts.push(`(L${s}${e?'-'+e:''})`);
        } else if(args.start_line!=null||args.end_line!=null){
          const s=args.start_line||1, e=args.end_line||'';
          parts.push(`(L${s}${e?'-'+e:''})`);
        }
        return parts.join(' ');
      }
      case 'write_file':{
        const f=args.file_path||args.file||args.path||args.filename||'';
        const short=shortenFilePath(f);
        const lines=args._lines||0;
        return short+(lines?' +'+lines:'');
      }
      case 'edit_file':{
        const f=args.file_path||args.file||args.path||args.filename||'';
        const short=shortenFilePath(f);
        const add=args._diff_add||0, del=args._diff_del||0;
        const diff=(add||del)?` +${add} -${del}`:'';
        return short+diff;
      }
      case 'execute':{
        return args.command||args.cmd||JSON.stringify(args).slice(0,200);
      }
      case 'ls':{
        return args.directory||args.path||args.dir||'.';
      }
      case 'glob':{
        const p=args.pattern||'';const d=args.directory||args.path||'';
        return p+(d?' in '+d:'');
      }
      case 'grep':{
        const p=args.pattern||'';const d=args.directory||args.path||'';
        return '"'+p+'"'+(d?' in '+d:'');
      }
      case 'web_search':{
        return args.query||args.q||JSON.stringify(args).slice(0,150);
      }
      case 'fetch_url':{
        return args.url||JSON.stringify(args).slice(0,200);
      }
      case 'task':{
        return args.description||args.task||JSON.stringify(args).slice(0,150);
      }
      case 'write_todos':case 'read_todos':{
        return fmtTodoArgs(args);
      }
      case 'save_memory':{
        const c=args.content||args.text||'';
        return c.length>100?c.slice(0,100)+'‚Ä¶':c;
      }
      default:{
        const s=JSON.stringify(args);
        return s.length>200?s.slice(0,200)+'‚Ä¶':s;
      }
    }
  }catch{return JSON.stringify(args).slice(0,200)}
}

// Generate HTML body for todo list (used in sec-body)
function fmtTodoBodyHtml(args){
  const todos=args&&(args.todos||args.items);
  if(!Array.isArray(todos)||!todos.length) return '';
  return '<div class="todo-list">'+todos.map(t=>{
    const st=t.status==='completed'?'‚úÖ':t.status==='in_progress'?'üîÑ':t.status==='cancelled'?'‚ùå':'‚¨ú';
    return `<div class="todo-row"><span class="todo-st">${st}</span><span class="todo-txt">${esc(t.content||t.text||'')}</span></div>`;
  }).join('')+'</div>';
}

// Generate HTML body for task (subagent) result ‚Äî shows inner tool calls + execution summary
function fmtTaskBodyHtml(resultStr){
  if(!resultStr) return '';
  let data;
  try{ data=JSON.parse(resultStr); }catch{ return ''; }
  if(!data||!data._task_meta) return '';
  if(!data.success){
    return `<div class="task-inner"><div class="task-inner-row"><span class="ti-info" style="color:var(--fg)">‚ö† ${esc(data.error||'Unknown error')}</span></div></div>`;
  }
  const summary=data.tool_calls_summary||[];
  const maxShown=8;
  let h='<div class="task-inner">';
  for(let i=0;i<Math.min(summary.length,maxShown);i++){
    const tc=summary[i];
    const icon=toolIcon(tc.name||'');
    const info=tc.info||'';
    const shortInfo=info.length>90?info.slice(0,87)+'‚Ä¶':info;
    h+=`<div class="task-inner-row"><span class="ti-icon">${icon}</span><span class="ti-name">${esc(tc.name||'')}</span><span class="ti-info">${esc(shortInfo)}</span></div>`;
  }
  if(summary.length>maxShown){
    h+=`<div class="task-inner-more">‚Ä¶ and ${summary.length-maxShown} more tool calls</div>`;
  }
  // Execution summary
  const parts=[];
  if(data.tool_count>0) parts.push(`${data.tool_count} tool uses`);
  if(data.execution_time!=null) parts.push(`cost: ${data.execution_time.toFixed(1)}s`);
  if(parts.length) h+=`<div class="task-summary">Execution Summary: ${parts.join(', ')}</div>`;
  h+='</div>';
  return h;
}

// Shorten file path for display: keep filename + parent dir
function shortenFilePath(p){
  if(!p)return '';
  const parts=p.replace(/\\/g,'/').split('/').filter(Boolean);
  if(parts.length<=2) return parts.join('/');
  return '‚Ä¶/'+parts.slice(-2).join('/');
}

// Tools that need HTML-rendered args (not just plain text escape)
const RICH_TOOLS=new Set(['task','write_todos','read_todos','read_file','write_file','edit_file']);
function isRichTool(name){return RICH_TOOLS.has(name)}

// Format todo/task args as readable text
function fmtTodoArgs(args){
  if(!args) return '';
  // write_todos: {todos: [{id,content,status},...]}
  const todos=args.todos||args.items;
  if(Array.isArray(todos)){
    return todos.map(t=>{
      const st=t.status==='completed'?'‚úÖ':t.status==='in_progress'?'üîÑ':t.status==='cancelled'?'‚ùå':'‚¨ú';
      return `${st} ${t.content||t.text||''}`;
    }).join(' | ');
  }
  const s=JSON.stringify(args);
  return s.length>200?s.slice(0,200)+'‚Ä¶':s;
}

// Rich HTML format for tool args (task, todo, file tools)
function fmtToolArgsHtml(name, args, argsStr){
  if(!args||typeof args!=='object') return esc(argsStr||'');
  // File tools: read_file, write_file, edit_file
  if(name==='read_file'){
    const f=args.file_path||args.file||args.path||args.filename||'';
    const short=shortenFilePath(f);
    let h=`<span class="file-path" title="${esc(f)}">${esc(short)}</span>`;
    if(args.offset!=null||args.limit!=null){
      const s=(args.offset||0)+1, e=args.limit?(args.offset||0)+args.limit:'';
      h+=` <span class="line-range">L${s}${e?'-'+e:''}</span>`;
    } else if(args.start_line!=null||args.end_line!=null){
      const s=args.start_line||1, e=args.end_line||'';
      h+=` <span class="line-range">L${s}${e?'-'+e:''}</span>`;
    }
    return h;
  }
  if(name==='write_file'){
    const f=args.file_path||args.file||args.path||args.filename||'';
    const short=shortenFilePath(f);
    const lines=args._lines||0;
    let h=`<span class="file-path" title="${esc(f)}">${esc(short)}</span>`;
    if(lines) h+=` <span class="diff-add">+${lines}</span>`;
    return h;
  }
  if(name==='edit_file'){
    const f=args.file_path||args.file||args.path||args.filename||'';
    const short=shortenFilePath(f);
    const add=args._diff_add||0, del=args._diff_del||0;
    let h=`<span class="file-path" title="${esc(f)}">${esc(short)}</span>`;
    if(add||del) h+=` <span class="diff-add">+${add}</span> <span class="diff-del">-${del}</span>`;
    return h;
  }
  if(name==='task'){
    const desc=args.description||args.task||'';
    const prompt=args.prompt||'';
    let h=`<span style="font-weight:600">${esc(desc)}</span>`;
    if(prompt){
      const short=prompt.length>120?prompt.slice(0,120)+'‚Ä¶':prompt;
      h+=`<br><span style="opacity:.6;font-size:10px">${esc(short)}</span>`;
    }
    return h;
  }
  if(name==='write_todos'||name==='read_todos'){
    const todos=args.todos||args.items;
    if(Array.isArray(todos)){
      const icons=todos.map((t,i)=>{
        const st=t.status==='completed'?'‚úÖ':t.status==='in_progress'?'üîÑ':t.status==='cancelled'?'‚ùå':'‚¨ú';
        return `${i+1} ${st}`;
      });
      return `<span style="font-size:11px">${todos.length} items ¬∑ ${icons.join(' ')}</span>`;
    }
  }
  return esc(argsStr||'');
}

// ============ UUID ============
function uid(){
  if(crypto && crypto.randomUUID) return 'w:'+crypto.randomUUID().replace(/-/g,'').slice(0,12);
  const a=new Uint8Array(8);crypto.getRandomValues(a);
  return 'w:'+Array.from(a,b=>b.toString(16).padStart(2,'0')).join('').slice(0,12);
}

// ============ THEME ============
function getTheme(){return localStorage.getItem('ag_theme')||'auto'}
function applyTheme(t){
  const d=document.documentElement;
  if(t==='dark')d.setAttribute('data-theme','dark');
  else if(t==='light')d.removeAttribute('data-theme');
  else{if(matchMedia('(prefers-color-scheme:dark)').matches)d.setAttribute('data-theme','dark');else d.removeAttribute('data-theme')}
  document.getElementById('themeBtn').innerHTML=d.hasAttribute('data-theme')?'&#x2600;':'&#x263E;';
}
function toggleTheme(){
  const c=getTheme();let n;
  if(c==='auto')n=matchMedia('(prefers-color-scheme:dark)').matches?'light':'dark';
  else n=c==='dark'?'light':'dark';
  localStorage.setItem('ag_theme',n);applyTheme(n);
}

// ============ INIT ============
document.addEventListener('DOMContentLoaded',()=>{
  applyTheme(getTheme());
  loadSessions();
  loadStatus();
  loadModels();
  setupDragDrop();
  document.getElementById('inputTa').focus();
  matchMedia('(prefers-color-scheme:dark)').addEventListener('change',()=>{if(getTheme()==='auto')applyTheme('auto')});
  renderChat();
  document.addEventListener('click',e=>{
    if(!document.getElementById('modelWrap').contains(e.target)){
      document.getElementById('modelDD').classList.remove('open');
    }
  });
  // scroll button visibility + track user scroll intent
  const chatArea=document.getElementById('chatArea');
  chatArea.addEventListener('scroll',()=>{
    updateScrollBtn();
    // If user scrolled near bottom, re-enable auto-scroll
    if(isNearBottom()) userScrolledUp=false;
  });
  // Detect user-initiated scroll (wheel / touch)
  chatArea.addEventListener('wheel',()=>{if(streaming && !isNearBottom()) userScrolledUp=true},{passive:true});
  chatArea.addEventListener('touchmove',()=>{if(streaming && !isNearBottom()) userScrolledUp=true},{passive:true});
});

async function loadStatus(){
  try{
    const r=await fetch(`${API}/api/status`);const d=await r.json();
    serverModel=d.model||'-';
    serverDir=d.base_dir||d.workspace||'';
    serverProvider=d.model_provider||'';
    serverModelName=d.model_name||'';
    serverVersion=d.version||'';
    document.getElementById('modelLabel').textContent=serverModelName||serverModel;
    if(serverVersion) document.getElementById('verLabel').textContent='v'+serverVersion;
    updateDirDisplay();
  }catch{}
}

async function loadModels(){
  try{
    const r=await fetch(`${API}/api/models`);
    modelsData=await r.json();
    renderModelDD();
  }catch{}
}

function updateDirDisplay(){
  if(serverDir){
    const p=serverDir.split('/').filter(Boolean);
    const short=p.length>3?'‚Ä¶/'+p.slice(-2).join('/'):serverDir;
    document.getElementById('dirVal').textContent=short;
    document.getElementById('dirWrap').title='Working Directory: '+serverDir+' (click to edit)';
    document.getElementById('dirEditInput').value=serverDir;
  }
}

// ============ MODEL DROPDOWN ============
function toggleModelDD(){
  document.getElementById('modelDD').classList.toggle('open');
}

function renderModelDD(){
  if(!modelsData)return;
  const dd=document.getElementById('modelDD');
  let h='';
  for(const [prov, models] of Object.entries(modelsData.providers)){
    h+=`<div class="dd-group"><div class="dd-group-title">${esc(prov)}</div>`;
    for(const m of models){
      const isCur=(prov===modelsData.current_provider && m===modelsData.current_name);
      h+=`<div class="dd-item${isCur?' current':''}" onclick="switchModel('${esc(prov)}','${esc(m)}')">
        <span>${esc(m)}</span>
      </div>`;
    }
    h+='</div>';
  }
  dd.innerHTML=h;
}

async function switchModel(provider, name){
  document.getElementById('modelDD').classList.remove('open');
  if(provider===serverProvider && name===serverModelName) return;
  document.getElementById('modelLabel').textContent=name+' ‚è≥';
  try{
    const r=await fetch(`${API}/api/model`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model_provider:provider,model_name:name}),
    });
    const d=await r.json();
    if(d.status==='ok'){
      serverProvider=provider;
      serverModelName=name;
      serverModel=d.model;
      document.getElementById('modelLabel').textContent=name;
      if(modelsData){modelsData.current_provider=provider;modelsData.current_name=name;renderModelDD()}
    }
  }catch(e){
    document.getElementById('modelLabel').textContent=serverModelName||'-';
  }
}

// ============ TOAST ============
let toastTimer=null;
function showToast(msg, duration=2500){
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'), duration);
}

// ============ WORKING DIR ============
let dirHistory=[];

function openDirModal(){
  const overlay=document.getElementById('dirModalOverlay');
  overlay.classList.add('open');
  const inp=document.getElementById('dirEditInput');
  inp.value=serverDir;
  closeDirHistoryDD();
  loadDirHistory();
  setTimeout(()=>inp.focus(),50);
}

function closeDirModal(e){
  if(e&&e.target!==e.currentTarget)return;
  closeDirHistoryDD();
  document.getElementById('dirModalOverlay').classList.remove('open');
}

async function loadDirHistory(){
  try{
    const r=await fetch(`${API}/api/config/dir_history`);
    const d=await r.json();
    dirHistory=d.history||[];
  }catch{ dirHistory=[]; }
}

function shortenPath(p){
  const home=p.startsWith('/Users/')?p.split('/').slice(0,3).join('/'):null;
  if(home&&p.startsWith(home)){
    const rel=p.slice(home.length);
    if(!rel||rel==='/') return '~';
    const parts=rel.split('/').filter(Boolean);
    if(parts.length<=2) return '~/'+parts.join('/');
    return '~/‚Ä¶/'+parts.slice(-2).join('/');
  }
  return p;
}

function renderDirHistory(filter){
  const dd=document.getElementById('dirHistoryDD');
  const q=(filter||'').toLowerCase();
  const filtered=q?dirHistory.filter(p=>p.toLowerCase().includes(q)):dirHistory;
  if(!filtered.length){
    dd.innerHTML='<div class="dir-history-empty">Êó†ÂéÜÂè≤ËÆ∞ÂΩï</div>';
    return;
  }
  dd.innerHTML=filtered.map(p=>`<div class="dir-history-item" onclick="selectDirHistory('${p.replace(/'/g,"\\'")}')">
    <div class="dh-short">${esc(shortenPath(p))}</div>
    <div class="dh-full">${esc(p)}</div>
  </div>`).join('');
}

function toggleDirHistory(){
  const dd=document.getElementById('dirHistoryDD');
  const btn=document.getElementById('dirToggleBtn');
  const isOpen=dd.classList.toggle('open');
  btn.classList.toggle('open',isOpen);
  if(isOpen) renderDirHistory();
}

function closeDirHistoryDD(){
  document.getElementById('dirHistoryDD').classList.remove('open');
  document.getElementById('dirToggleBtn').classList.remove('open');
}

function filterDirHistory(){
  const dd=document.getElementById('dirHistoryDD');
  if(dd.classList.contains('open')){
    renderDirHistory(document.getElementById('dirEditInput').value);
  }
}

function selectDirHistory(path){
  document.getElementById('dirEditInput').value=path;
  closeDirHistoryDD();
  document.getElementById('dirEditInput').focus();
}

async function saveDir(){
  const inp=document.getElementById('dirEditInput');
  const val=inp.value.trim();
  if(!val)return;
  try{
    const r=await fetch(`${API}/api/config/base_dir`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({base_dir:val}),
    });
    if(!r.ok){
      const err=await r.json().catch(()=>null);
      showToast(err?.detail||'Êñá‰ª∂Â§πË∑ØÂæÑ‰∏çÂ≠òÂú®ÔºåÈúÄË¶ÅÂÜô‰∏Ä‰∏™Â≠òÂú®ÁöÑË∑ØÂæÑ');
      return;
    }
    const d=await r.json();
    if(d.status==='ok'){
      serverDir=d.base_dir;
      updateDirDisplay();
      loadDirHistory();
      if(d.created) showToast('Â∑≤Ëá™Âä®ÂàõÂª∫Êñá‰ª∂Â§π: '+d.base_dir);
    }
  }catch{
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Ë∑ØÂæÑ');
    return;
  }
  document.getElementById('dirModalOverlay').classList.remove('open');
}

function copyDir(){
  const inp=document.getElementById('dirEditInput');
  const val=inp?inp.value.trim():'';
  const text=val||serverDir;
  if(!text)return;
  // Use clipboard API with fallback for non-HTTPS
  if(navigator.clipboard&&window.isSecureContext){
    navigator.clipboard.writeText(text).then(()=>showToast('Â∑≤Â§çÂà∂: '+text));
  }else{
    const ta=document.createElement('textarea');
    ta.value=text;ta.style.cssText='position:fixed;left:-9999px';
    document.body.appendChild(ta);ta.select();
    try{document.execCommand('copy');showToast('Â∑≤Â§çÂà∂: '+text);}
    catch(e){showToast('Â§çÂà∂Â§±Ë¥•');}
    document.body.removeChild(ta);
  }
}

function openInFinder(){
  if(!serverDir)return;
  fetch(`${API}/api/open`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({path:serverDir,app:'finder'}),
  }).catch(()=>{
    window.open('file://'+serverDir,'_blank');
  });
}

function openInTerminal(){
  if(!serverDir)return;
  fetch(`${API}/api/open`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({path:serverDir,app:'terminal'}),
  }).catch(()=>{});
}

// ============ DRAG & DROP ============
function setupDragDrop(){
  const box=document.getElementById('inputBox');
  box.addEventListener('dragover',e=>{e.preventDefault();box.classList.add('dragover')});
  box.addEventListener('dragleave',()=>box.classList.remove('dragover'));
  box.addEventListener('drop',e=>{
    e.preventDefault();box.classList.remove('dragover');
    if(e.dataTransfer.files.length) addFiles(e.dataTransfer.files);
  });
}

// ============ FILE HANDLING ============
function onFilePick(e){
  if(e.target.files.length) addFiles(e.target.files);
  e.target.value='';
}
function addFiles(fileList){
  for(const f of fileList) pendingFiles.push(f);
  renderFileList();
}
function removeFile(i){
  pendingFiles.splice(i,1);
  renderFileList();
}
function renderFileList(){
  const el=document.getElementById('fileList');
  if(!pendingFiles.length){el.innerHTML='';return}
  el.innerHTML=pendingFiles.map((f,i)=>{
    const sz=f.size>1024?(f.size/1024).toFixed(1)+'K':f.size+'B';
    return `<div class="file-chip"><span>${esc(f.name)}</span><span style="color:var(--fg3)">(${sz})</span><span class="fx" onclick="removeFile(${i})">&#x2715;</span></div>`;
  }).join('');
}

async function uploadFiles(targetDir){
  const uploaded=[];
  for(const f of pendingFiles){
    const fd=new FormData();
    fd.append('file',f);
    if(targetDir)fd.append('target_dir',targetDir);
    try{
      const r=await fetch(`${API}/api/upload`,{method:'POST',body:fd});
      const d=await r.json();
      uploaded.push(d.path);
    }catch(e){uploaded.push(`[upload failed: ${f.name}]`)}
  }
  pendingFiles=[];
  renderFileList();
  return uploaded;
}

// ============ SESSIONS ============
function loadSessions(){
  try{sessions=JSON.parse(localStorage.getItem('ag_s')||'{}')}catch{sessions={}}
  renderSidebar();
  const last=localStorage.getItem('ag_a');
  if(last&&sessions[last])switchTo(last);
}
function save(){localStorage.setItem('ag_s',JSON.stringify(sessions))}

function newSession(){
  if(streaming)return;
  const id=uid();
  sessions[id]={title:'New Chat',msgs:[],ts:Date.now(),tokIn:0,tokOut:0,dir:''};
  save();switchTo(id);renderSidebar();
  document.getElementById('inputTa').focus();
}

function switchTo(id){
  curSess=id;
  localStorage.setItem('ag_a',id);
  const s=sessions[id];
  updateTok(s);
  renderSidebar();renderChat();
}

let _confirmCb=null;
function showConfirm(msg,cb){
  _confirmCb=cb;
  document.getElementById('confirmMsg').textContent=msg;
  document.getElementById('confirmOverlay').classList.add('open');
}
function confirmOk(){
  document.getElementById('confirmOverlay').classList.remove('open');
  if(_confirmCb){_confirmCb();_confirmCb=null}
}
function confirmCancel(e){
  if(e&&e.target!==e.currentTarget)return;
  document.getElementById('confirmOverlay').classList.remove('open');
  _confirmCb=null;
}

function delSession(id,ev){
  ev.stopPropagation();
  showConfirm('Á°ÆÂÆöÂà†Èô§ËØ•‰ºöËØùÔºü',()=>{
    delete sessions[id];save();
    fetch(`${API}/api/sessions/${id}`,{method:'DELETE'}).catch(()=>{});
    if(curSess===id){curSess=null;updateTok(null);renderChat()}
    renderSidebar();
  });
}

function filterSessions(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('.s-item').forEach(el=>{
    el.style.display=el.querySelector('.ti').textContent.toLowerCase().includes(q)?'':'none';
  });
}

function renderSidebar(){
  const el=document.getElementById('sessionList');
  const ids=Object.keys(sessions).sort((a,b)=>sessions[b].ts-sessions[a].ts);
  if(!ids.length){el.innerHTML='<div class="s-empty">No sessions</div>';return}
  el.innerHTML=ids.map(id=>{
    const s=sessions[id];const act=id===curSess?'active':'';
    const n=s.msgs?s.msgs.filter(m=>m.role==='user').length:0;
    return `<div class="s-item ${act}" onclick="switchTo('${id}')">
      <div class="ti">${esc(s.title)}</div>
      <div class="mt">${n} msg ¬∑ ${ago(s.ts)}</div>
      <button class="db" onclick="delSession('${id}',event)" title="Delete">&#x2715;</button>
    </div>`;
  }).join('');
}

function updateTok(s){
  const ti=s?s.tokIn:0, to=s?s.tokOut:0;
  document.getElementById('tokIn').textContent=fmtN(ti);
  document.getElementById('tokOut').textContent=fmtN(to);
  const tip=document.getElementById('tokTip');
  if(tip){
    const total=ti+to;
    tip.textContent=`Input: ${ti.toLocaleString()} tokens ¬∑ Output: ${to.toLocaleString()} tokens ¬∑ Total: ${total.toLocaleString()}`;
  }
}
function fmtN(n){if(!n)return'0';if(n>=1000)return(n/1000).toFixed(1)+'K';return String(n)}

// ============ CHAT RENDER ============
function renderChat(){
  const c=document.getElementById('messages');
  if(!curSess||!sessions[curSess]||!sessions[curSess].msgs.length){
    c.innerHTML=`<div class="welcome"><div class="w-icon">A</div><h2>Agentica</h2><p>AI Agent ‚Äî send a message to get started.</p></div>`;
    return;
  }
  c.innerHTML=sessions[curSess].msgs.map(renderMsg).join('');
  scrollEnd();
}

function renderMsg(m){
  if(m.role==='user'){
    let h=`<div class="m m-u"><div class="bub">${esc(m.content)}`;
    if(m.files&&m.files.length) h+=m.files.map(f=>`<br><span style="font-size:11px;color:var(--fg3)">üìé ${esc(f)}</span>`).join('');
    h+=`</div></div>`;
    return h;
  }
  let h='<div class="m m-a">';
  if(m.steps&&m.steps.length){
    // Group steps into sections: consecutive thinking ‚Üí one block, consecutive tools ‚Üí one block
    const sections=[];
    for(const st of m.steps){
      if(st.type==='thinking'){
        const last=sections[sections.length-1];
        if(last&&last.type==='thinking'){last.items.push(st)}
        else sections.push({type:'thinking',items:[st]});
      } else if(st.type==='tool'){
        const last=sections[sections.length-1];
        if(last&&last.type==='tools'){last.items.push(st)}
        else sections.push({type:'tools',items:[st]});
      }
    }
    for(const sec of sections){
      if(sec.type==='thinking'){
        const text=sec.items.map(s=>s.text).join('\n');
        const isShort=text.length<150&&!text.includes('\n');
        if(isShort){
          // Short thinking ‚Äî inline, no collapse
          h+=`<div class="sec-block sec-thinking"><div class="sec-toggle" style="cursor:default">
            <span class="sec-icon">üí≠</span>
            <span class="sec-lbl">Thinking</span>
            <span class="sec-detail">${esc(text)}</span>
          </div></div>`;
        } else {
          const preview=text.slice(0,60).replace(/\n/g,' ')+(text.length>60?'‚Ä¶':'');
          h+=`<div class="sec-block sec-thinking"><div class="sec-toggle" onclick="toggleSec(this)">
            <span class="arrow">&#x25B8;</span>
            <span class="sec-icon">üí≠</span>
            <span class="sec-lbl">Thinking</span>
            <span class="sec-detail">${esc(preview)}</span>
          </div><div class="sec-body">
            <div class="think-content">${esc(text)}</div>
          </div></div>`;
        }
      } else if(sec.type==='tools'){
        const n=sec.items.length;
        if(n===1){
          // Single tool ‚Äî inline display with tool name in title, no collapse needed
          const st=sec.items[0];
          const icon=toolIcon(st.name||'');
          const dname=toolDisplay(st.name||'tool');
          const sclass=toolSecClass(st.name||'');
          const argsHtml=isRichTool(st.name)?fmtToolArgsHtml(st.name,st.rawArgs,st.argsStr):esc(st.argsStr||'');
          const isTodo=(st.name==='write_todos'||st.name==='read_todos');
          const isTask=(st.name==='task');
          const todoBody=isTodo?fmtTodoBodyHtml(st.rawArgs):'';
          const taskBody=isTask?fmtTaskBodyHtml(st.result):'';
          const hasBody=st.result||todoBody||taskBody;
          h+=`<div class="sec-block ${sclass}"><div class="sec-toggle"${hasBody?' onclick="toggleSec(this)" style="cursor:pointer"':' style="cursor:default"'}>
            ${hasBody?'<span class="arrow">&#x25B8;</span>':''}
            <span class="sec-icon">${icon}</span>
            <span class="sec-lbl tool-inline">${esc(dname)}</span>
            <span class="sec-detail tool-inline-args">${argsHtml}</span>
          </div>`;
          if(hasBody){
            let bodyH='';
            if(todoBody) bodyH+=todoBody;
            if(taskBody) bodyH+=taskBody;
            if(st.result&&!taskBody) bodyH+=`<div class="tool-result" style="padding-left:12px">${esc(st.result)}</div>`;
            h+=`<div class="sec-body">${bodyH}</div>`;
          }
          h+=`</div>`;
        } else {
          h+=`<div class="sec-block sec-tools"><div class="sec-toggle" onclick="toggleSec(this)">
            <span class="arrow">&#x25B8;</span>
            <span class="sec-icon">üîß</span>
            <span class="sec-lbl">Tool Calls</span>
            <span class="sec-detail">${n} tools</span>
          </div><div class="sec-body">`;
          for(const st of sec.items){
            const icon=toolIcon(st.name||'');
            const dname=toolDisplay(st.name||'tool');
            const argsHtml=isRichTool(st.name)?fmtToolArgsHtml(st.name,st.rawArgs,st.argsStr):esc(st.argsStr||'');
            h+=`<div class="tool-item"><span class="t-icon">${icon}</span><span class="t-name">${esc(dname)}</span><span class="t-args">${argsHtml}</span></div>`;
            if(st.result) h+=`<div class="tool-result">${esc(st.result)}</div>`;
          }
          h+=`</div></div>`;
        }
      }
    }
  }
  h+=`<div class="bub">${md(m.content)}</div></div>`;
  return h;
}

function toggleSec(el){
  const arrow=el.querySelector('.arrow');
  const body=el.nextElementSibling;
  const open=body.classList.toggle('open');
  arrow.classList.toggle('open',open);
}

function scrollEnd(){
  const a=document.getElementById('chatArea');
  userScrolledUp=false;
  requestAnimationFrame(()=>{a.scrollTop=a.scrollHeight});
  updateScrollBtn();
}

// Check if user is near the bottom (within half a screen)
function isNearBottom(){
  const a=document.getElementById('chatArea');
  return (a.scrollHeight - a.scrollTop - a.clientHeight) < a.clientHeight*0.5;
}

// Auto-scroll only if user hasn't deliberately scrolled up
function autoScroll(){
  if(userScrolledUp){
    updateScrollBtn();
    return;
  }
  if(isNearBottom()){
    scrollEnd();
  } else {
    updateScrollBtn();
  }
}

function updateScrollBtn(){
  const btn=document.getElementById('scrollBottomBtn');
  if(!btn)return;
  const a=document.getElementById('chatArea');
  // Show button when scrolled up more than ~half a screen
  const threshold=a.clientHeight*0.5;
  const far=(a.scrollHeight - a.scrollTop - a.clientHeight) > threshold;
  btn.classList.toggle('visible', far);
}

// ============ SEND / STREAM ============
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();if(!streaming)sendMessage()}}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,200)+'px'}

function onAction(){
  if(streaming){stopGen();return}
  sendMessage();
}

async function sendMessage(){
  const ta=document.getElementById('inputTa');
  let text=ta.value.trim();
  if(!text&&!pendingFiles.length)return;
  if(streaming)return;

  if(!curSess)newSession();
  const s=sessions[curSess];

  // upload files first
  let uploadedPaths=[];
  if(pendingFiles.length){
    const targetDir=s.dir||serverDir||'';
    uploadedPaths=await uploadFiles(targetDir);
    if(!text) text='I uploaded files: '+uploadedPaths.join(', ');
    else text+='\n\n[Attached files: '+uploadedPaths.join(', ')+']';
  }

  // add user msg
  const userMsg={role:'user',content:ta.value.trim()||text};
  if(uploadedPaths.length) userMsg.files=uploadedPaths;
  s.msgs.push(userMsg);
  if(s.msgs.filter(m=>m.role==='user').length===1){
    s.title=userMsg.content.slice(0,50);
  }
  s.ts=Date.now();
  save();renderChat();renderSidebar();

  // clear
  ta.value='';ta.style.height='auto';

  // stream
  streaming=true;
  setStop();
  abortCtrl=new AbortController();

  const aiMsg={role:'assistant',content:'',steps:[]};
  s.msgs.push(aiMsg);
  appendLive();

  // current thinking accumulator
  let curThinking='';
  let approxIn=0,approxOut=0;
  approxIn=Math.ceil(text.length/3.5);

  try{
    const resp=await fetch(`${API}/api/chat/stream`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:text,session_id:curSess,user_id:'default'}),
      signal:abortCtrl.signal,
    });
    const reader=resp.body.getReader();
    const dec=new TextDecoder();
    let buf='';

    while(true){
      const{done,value}=await reader.read();
      if(done)break;
      buf+=dec.decode(value,{stream:true});
      const lines=buf.split('\n');buf=lines.pop();
      for(const line of lines){
        if(!line.startsWith('data: '))continue;
        const raw=line.slice(6);if(raw==='[DONE]')continue;
        try{
          const evt=JSON.parse(raw);
          if(evt.event==='thinking'){
            // Accumulate thinking text into current thinking step
            curThinking+=evt.data;
            approxOut+=Math.ceil(evt.data.length/3.5);
            const last=aiMsg.steps[aiMsg.steps.length-1];
            if(last&&last.type==='thinking'){
              last.text=curThinking;
            } else {
              aiMsg.steps.push({type:'thinking',text:curThinking});
            }
            updateLiveSteps(aiMsg);
          } else if(evt.event==='tool_call'){
            // Reset thinking accumulator ‚Äî next thinking chunk starts fresh
            curThinking='';
            const name=evt.data.name||'tool';
            const argsStr=fmtToolArgs(name,evt.data.args);
            aiMsg.steps.push({type:'tool',name:name,text:name,argsStr:argsStr,rawArgs:evt.data.args});
            updateLiveSteps(aiMsg);
          } else if(evt.event==='tool_result'){
            // Attach result to the last matching tool step (by name, fallback to last tool)
            const rName=evt.data&&evt.data.name?evt.data.name:null;
            const res=evt.data&&evt.data.result?evt.data.result:(typeof evt.data==='string'?evt.data:JSON.stringify(evt.data));
            let target=null;
            if(rName){
              for(let i=aiMsg.steps.length-1;i>=0;i--){
                if(aiMsg.steps[i].type==='tool'&&aiMsg.steps[i].name===rName&&!aiMsg.steps[i].result){target=aiMsg.steps[i];break}
              }
            }
            if(!target) target=findLastTool(aiMsg.steps);
            if(target) target.result=(target.result||'')+res;
            updateLiveSteps(aiMsg);
          } else if(evt.event==='content'){
            if(curThinking){curThinking=''}
            aiMsg.content+=evt.data;
            approxOut+=Math.ceil(evt.data.length/3.5);
            updateLiveContent(aiMsg);
          } else if(evt.event==='done'){
            if(evt.data){
              const gotIn=evt.data.input_tokens||0;
              const gotOut=evt.data.output_tokens||0;
              if(gotIn>0||gotOut>0){
                s.tokIn=(s.tokIn||0)+gotIn;
                s.tokOut=(s.tokOut||0)+gotOut;
              } else {
                s.tokIn=(s.tokIn||0)+approxIn;
                s.tokOut=(s.tokOut||0)+approxOut;
              }
              updateTok(s);
            }
          } else if(evt.event==='error'){
            aiMsg.content+='\n\n**Error:** '+evt.data;
            updateLiveContent(aiMsg);
          }
        }catch{}
      }
    }
  }catch(err){
    if(err.name!=='AbortError') aiMsg.content+='\n\n**Error:** '+err.message;
    else aiMsg.content+=aiMsg.content?'\n\n*(stopped)*':'*(stopped)*';
  }

  streaming=false;abortCtrl=null;userScrolledUp=false;
  setSend();
  updateScrollBtn();
  s.ts=Date.now();save();
  renderChat();renderSidebar();
  document.getElementById('inputTa').focus();
}

function findLastTool(steps){
  for(let i=steps.length-1;i>=0;i--){
    if(steps[i].type==='tool')return steps[i];
  }
  return null;
}

function stopGen(){if(abortCtrl)abortCtrl.abort()}

// ============ LIVE DOM ============
function appendLive(){
  const c=document.getElementById('messages');
  const w=c.querySelector('.welcome');if(w)w.remove();
  userToggledSections={};
  const div=document.createElement('div');
  div.className='m m-a streaming';div.id='live';
  div.innerHTML=`<div id="live-sections"></div>
    <div class="bub" id="live-bub"></div>`;
  c.appendChild(div);scrollEnd();
}

function updateLiveContent(msg){
  const el=document.getElementById('live-bub');
  if(el){el.innerHTML=md(msg.content);autoScroll()}
}

// Track user-toggled sections: key = section index, value = forced open/close state
let userToggledSections={};

function updateLiveSteps(msg){
  const el=document.getElementById('live-sections');
  if(!el)return;

  // Group steps into sections (same logic as renderMsg)
  const sections=[];
  for(const st of msg.steps){
    if(st.type==='thinking'){
      const last=sections[sections.length-1];
      if(last&&last.type==='thinking'){last.items.push(st)}
      else sections.push({type:'thinking',items:[st]});
    } else if(st.type==='tool'){
      const last=sections[sections.length-1];
      if(last&&last.type==='tools'){last.items.push(st)}
      else sections.push({type:'tools',items:[st]});
    }
  }

  const existingBlocks=el.querySelectorAll('.sec-block');

  for(let si=0;si<sections.length;si++){
    const sec=sections[si];
    const isLast=(si===sections.length-1);
    const existing=existingBlocks[si];

    if(existing){
      // Update existing block in place ‚Äî preserve user toggle state
      const body=existing.querySelector('.sec-body');
      const arrow=existing.querySelector('.arrow');
      const userState=userToggledSections[si];

      if(sec.type==='thinking'){
        const text=sec.items.map(s=>s.text).join('\n');
        const isShort=text.length<150&&!text.includes('\n');
        const detail=existing.querySelector('.sec-detail');
        const tc=existing.querySelector('.think-content');
        const lbl=existing.querySelector('.sec-lbl');

        if(isShort&&!isLast){
          // Convert to inline display
          if(detail) detail.textContent=text;
          if(lbl) lbl.textContent='Thinking';
          if(body) body.classList.remove('open');
          if(arrow) arrow.style.display='none';
          existing.querySelector('.sec-toggle').onclick=null;
          existing.querySelector('.sec-toggle').style.cursor='default';
        } else {
          // Collapsible ‚Äî still streaming or long
          if(tc) tc.textContent=text;
          if(lbl) lbl.textContent=isLast?'Thinking‚Ä¶':'Thinking';
          if(detail){
            const preview=text.slice(0,60).replace(/\n/g,' ')+(text.length>60?'‚Ä¶':'');
            detail.textContent=preview;
          }
          if(arrow) arrow.style.display='';
          if(userState===undefined){
            const shouldOpen=isLast;
            if(body) body.classList.toggle('open',shouldOpen);
            if(arrow) arrow.classList.toggle('open',shouldOpen);
          }
        }
      } else if(sec.type==='tools'){
        const n=sec.items.length;
        if(n===1){
          // Single tool ‚Äî inline in title
          const st=sec.items[0];
          const icon=toolIcon(st.name||'');
          const dname=toolDisplay(st.name||'tool');
          const sclass=toolSecClass(st.name||'');
          const argsHtml=isRichTool(st.name)?fmtToolArgsHtml(st.name,st.rawArgs,st.argsStr):esc(st.argsStr||'');
          const isTodo=(st.name==='write_todos'||st.name==='read_todos');
          const isTask=(st.name==='task');
          const todoBody=isTodo?fmtTodoBodyHtml(st.rawArgs):'';
          const taskBody=isTask?fmtTaskBodyHtml(st.result):'';
          // Update sec-block class for todo/task styling
          existing.className='sec-block '+sclass;
          const toggle=existing.querySelector('.sec-toggle');
          const iconEl=existing.querySelector('.sec-icon');
          const lbl=existing.querySelector('.sec-lbl');
          const detail=existing.querySelector('.sec-detail');
          if(iconEl) iconEl.textContent=icon;
          if(lbl){lbl.textContent=dname;lbl.classList.add('tool-inline');}
          if(detail){detail.innerHTML=argsHtml;detail.classList.add('tool-inline-args');}
          // Show arrow+body if there's a result, todo body, or task body
          const hasBody=st.result||todoBody||taskBody;
          if(body){
            if(hasBody){
              let bodyH='';
              if(todoBody) bodyH+=todoBody;
              if(taskBody) bodyH+=taskBody;
              if(st.result&&!taskBody) bodyH+=`<div class="tool-result" style="padding-left:12px">${esc(st.result)}</div>`;
              body.innerHTML=bodyH;
              if(arrow){arrow.style.display='';toggle.onclick=function(){toggleLiveSec(this,si)}; toggle.style.cursor='pointer';}
            } else {
              body.innerHTML='';
              if(arrow) arrow.style.display='none';
              toggle.style.cursor='default';
            }
          }
          if(userState===undefined&&body){
            body.classList.toggle('open',isLast&&!!hasBody);
            if(arrow) arrow.classList.toggle('open',isLast&&!!hasBody);
          }
        } else {
          // Multi-tool ‚Äî standard collapsible
          const detail=existing.querySelector('.sec-detail');
          if(detail) detail.textContent=`${n} tools`;
          let itemsH='';
          for(const st of sec.items){
            const icon=toolIcon(st.name||'');
            const dname=toolDisplay(st.name||'tool');
            const argsHtml=isRichTool(st.name)?fmtToolArgsHtml(st.name,st.rawArgs,st.argsStr):esc(st.argsStr||'');
            itemsH+=`<div class="tool-item"><span class="t-icon">${icon}</span><span class="t-name">${esc(dname)}</span><span class="t-args">${argsHtml}</span></div>`;
            if(st.result) itemsH+=`<div class="tool-result">${esc(st.result)}</div>`;
          }
          if(body) body.innerHTML=itemsH;
          if(userState===undefined){
            const shouldOpen=isLast;
            if(body) body.classList.toggle('open',shouldOpen);
            if(arrow) arrow.classList.toggle('open',shouldOpen);
          }
        }
      }
    } else {
      // New section ‚Äî create fresh
      const div=document.createElement('div');
      if(sec.type==='thinking'){
        const text=sec.items.map(s=>s.text).join('\n');
        div.className='sec-block sec-thinking';
        // During streaming, thinking is always expanding so use collapsible
        div.innerHTML=`<div class="sec-toggle" onclick="toggleLiveSec(this,${si})">
          <span class="arrow${isLast?' open':''}">&#x25B8;</span>
          <span class="sec-icon">üí≠</span>
          <span class="sec-lbl">Thinking${isLast?'‚Ä¶':''}</span>
          <span class="sec-detail"></span>
        </div><div class="sec-body${isLast?' open':''}">
          <div class="think-content">${esc(text)}</div>
        </div>`;
      } else if(sec.type==='tools'){
        const n=sec.items.length;
        if(n===1){
          const st=sec.items[0];
          const icon=toolIcon(st.name||'');
          const dname=toolDisplay(st.name||'tool');
          const sclass=toolSecClass(st.name||'');
          const argsHtml=isRichTool(st.name)?fmtToolArgsHtml(st.name,st.rawArgs,st.argsStr):esc(st.argsStr||'');
          div.className='sec-block '+sclass;
          div.innerHTML=`<div class="sec-toggle" style="cursor:default">
            <span class="arrow" style="display:none">&#x25B8;</span>
            <span class="sec-icon">${icon}</span>
            <span class="sec-lbl tool-inline">${esc(dname)}</span>
            <span class="sec-detail tool-inline-args">${argsHtml}</span>
          </div><div class="sec-body"></div>`;
        } else {
          let itemsH='';
          for(const st of sec.items){
            const icon=toolIcon(st.name||'');
            const dname=toolDisplay(st.name||'tool');
            const argsHtml=isRichTool(st.name)?fmtToolArgsHtml(st.name,st.rawArgs,st.argsStr):esc(st.argsStr||'');
            itemsH+=`<div class="tool-item"><span class="t-icon">${icon}</span><span class="t-name">${esc(dname)}</span><span class="t-args">${argsHtml}</span></div>`;
            if(st.result) itemsH+=`<div class="tool-result">${esc(st.result)}</div>`;
          }
          div.className='sec-block sec-tools';
          div.innerHTML=`<div class="sec-toggle" onclick="toggleLiveSec(this,${si})">
            <span class="arrow${isLast?' open':''}">&#x25B8;</span>
            <span class="sec-icon">üîß</span>
            <span class="sec-lbl">Tool Calls</span>
            <span class="sec-detail">${n} tools</span>
          </div><div class="sec-body${isLast?' open':''}">
            ${itemsH}
          </div>`;
        }
      }
      // Close previous last section if user didn't manually toggle it
      if(el.children.length>0){
        const prevIdx=el.children.length-1;
        if(userToggledSections[prevIdx]===undefined){
          const prevBlock=el.children[prevIdx];
          const prevBody=prevBlock.querySelector('.sec-body');
          const prevArrow=prevBlock.querySelector('.arrow');
          if(prevBody){prevBody.classList.remove('open')}
          if(prevArrow){prevArrow.classList.remove('open')}
        }
      }
      el.appendChild(div);
    }
  }

  // Auto-scroll the last open sec-body
  const bodies=el.querySelectorAll('.sec-body.open');
  if(bodies.length){const last=bodies[bodies.length-1];last.scrollTop=last.scrollHeight};
  autoScroll();
}

// Toggle for live streaming sections ‚Äî records user intent
function toggleLiveSec(el,sectionIdx){
  const arrow=el.querySelector('.arrow');
  const body=el.nextElementSibling;
  const isOpen=body.classList.toggle('open');
  arrow.classList.toggle('open',isOpen);
  userToggledSections[sectionIdx]=isOpen;
}

// ============ ACTION BTN ============
const ICON_SEND='<svg viewBox="0 0 16 16" width="16" height="16"><path d="M13.5 3.5l-4 4m4-4v3m-4-3h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.5 6.5H3a.5.5 0 00-.5.5v6a.5.5 0 00.5.5h6a.5.5 0 00.5-.5V9.5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
const ICON_ENTER='<svg viewBox="0 0 16 16" width="16" height="16"><path d="M12 3v5a2 2 0 01-2 2H4m0 0l3-3M4 10l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
const ICON_STOP='<svg viewBox="0 0 16 16" width="16" height="16"><rect x="3" y="3" width="10" height="10" rx="1.5" fill="currentColor"/></svg>';
function setSend(){
  const b=document.getElementById('actBtn');
  b.className='act-btn send';b.innerHTML=ICON_ENTER;b.title='Send (Enter)';b.disabled=false;
}
function setStop(){
  const b=document.getElementById('actBtn');
  b.className='act-btn stop';b.innerHTML=ICON_STOP;b.title='Stop generation';b.disabled=false;
}

// ============ MARKDOWN ============
function md(text){
  if(!text)return '';
  let h=text;
  // Preserve LaTeX formulas before escaping HTML
  const mathBlocks=[];
  // Block math: $$...$$  or \[...\]
  h=h.replace(/\$\$([\s\S]*?)\$\$/g,(_,m)=>{mathBlocks.push({tex:m.trim(),display:true});return `%%MATH${mathBlocks.length-1}%%`});
  h=h.replace(/\\\[([\s\S]*?)\\\]/g,(_,m)=>{mathBlocks.push({tex:m.trim(),display:true});return `%%MATH${mathBlocks.length-1}%%`});
  // Inline math: $...$  or \(...\)
  h=h.replace(/\$([^\$\n]+?)\$/g,(_,m)=>{mathBlocks.push({tex:m.trim(),display:false});return `%%MATH${mathBlocks.length-1}%%`});
  h=h.replace(/\\\((.*?)\\\)/g,(_,m)=>{mathBlocks.push({tex:m.trim(),display:false});return `%%MATH${mathBlocks.length-1}%%`});

  h=h.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  h=h.replace(/```(\w*)\n([\s\S]*?)```/g,(_,lang,code)=>`<pre><code class="lang-${lang}">${code.trim()}</code></pre>`);
  h=h.replace(/`([^`]+)`/g,'<code>$1</code>');
  h=h.replace(/^###### (.+)$/gm,'<h6>$1</h6>');
  h=h.replace(/^##### (.+)$/gm,'<h5>$1</h5>');
  h=h.replace(/^#### (.+)$/gm,'<h4>$1</h4>');
  h=h.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  h=h.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  h=h.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  h=h.replace(/^---+$/gm,'<hr>');
  h=h.replace(/\*\*\*(.*?)\*\*\*/g,'<strong><em>$1</em></strong>');
  h=h.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*(.*?)\*/g,'<em>$1</em>');
  h=h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1" style="max-width:100%;border-radius:8px;margin:8px 0">');
  h=h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  h=h.replace(/^&gt; (.+)$/gm,'<blockquote>$1</blockquote>');
  h=h.replace(/^\|(.+)\|\s*\n\|[-| :]+\|\s*\n((?:\|.+\|\s*\n?)*)/gm, (_, header, body) => {
    const ths=header.split('|').map(s=>s.trim()).filter(Boolean).map(s=>`<th>${s}</th>`).join('');
    const rows=body.trim().split('\n').map(row=>{
      const tds=row.split('|').map(s=>s.trim()).filter(Boolean).map(s=>`<td>${s}</td>`).join('');
      return `<tr>${tds}</tr>`;
    }).join('');
    return `<table><thead><tr>${ths}</tr></thead><tbody>${rows}</tbody></table>`;
  });
  h=h.replace(/^(\d+)\. (.+)$/gm,'<oli>$2</oli>');
  h=h.replace(/((<oli>.*<\/oli>\n?)+)/g,m=>'<ol>'+m.replace(/<\/?oli>/g,s=>s.replace('oli','li')).replace(/\n/g,'')+'</ol>');
  h=h.replace(/^[-*] (.+)$/gm,'<uli>$1</uli>');
  h=h.replace(/((<uli>.*<\/uli>\n?)+)/g,m=>'<ul>'+m.replace(/<\/?uli>/g,s=>s.replace('uli','li')).replace(/\n/g,'')+'</ul>');
  h=h.replace(/\n\n/g,'</p><p>');
  h=h.replace(/\n/g,'<br>');
  h='<p>'+h+'</p>';
  h=h.replace(/<p><\/p>/g,'');
  h=h.replace(/<p>(<(?:h[1-6]|pre|table|ul|ol|blockquote|hr)[^>]*>)/g,'$1');
  h=h.replace(/(<\/(?:h[1-6]|pre|table|ul|ol|blockquote|hr)>)<\/p>/g,'$1');
  h=h.replace(/<br>(<(?:ul|ol|h[1-6]|pre|table|blockquote|hr)[^>]*>)/g,'$1');
  h=h.replace(/(<\/(?:ul|ol|h[1-6]|pre|table|blockquote|hr)>)<br>/g,'$1');

  // Render LaTeX math
  h=h.replace(/%%MATH(\d+)%%/g,(_,i)=>{
    const m=mathBlocks[parseInt(i)];
    if(!m)return '';
    try{
      if(typeof katex!=='undefined'){
        return katex.renderToString(m.tex,{displayMode:m.display,throwOnError:false,strict:false});
      }
    }catch(e){}
    return m.display?`<div class="katex-display">${esc(m.tex)}</div>`:`<span>${esc(m.tex)}</span>`;
  });
  return h;
}

// ============ UTILS ============
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function ago(ts){const d=Date.now()-ts;const m=Math.floor(d/60000);if(m<1)return'now';if(m<60)return m+'m';const h=Math.floor(m/60);if(h<24)return h+'h';return Math.floor(h/24)+'d'}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('collapsed')}
</script>
</body>
</html>
